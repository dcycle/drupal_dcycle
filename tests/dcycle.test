<?php

/**
 * @file
 * Simpletests for Dcycle
 */

/**
 * Make sure we don't explode if Dcycle is not present.
 */
module_load_include('test', 'Dcycle', 'tests/dcycle_base');
if (!module_exists('Dcycle')) {
  drupal_set_message(t('Some tests are not shown because Dcycle is not enabled'), 'warning', FALSE);
  return;
}

/**
 * Test that Dcycle works as expected.
 */
class dcycleTestCase extends dcycleTestBase {
  /**
   * Overrides setUp().
   */
  public function setUp() {
    parent::setUp('dcycle', 'mockable');
    mockable_set();
  }

  /**
   * Overrides getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => 'Dcycle functionality',
      'description' => 'Test Dcycle functionality.',
      'group' => 'Dcycle',
    );
  }

  /**
   * Test the admin screen.
   *
   * Because this function starts with test..., it is called.
   */
  public function testDcycle() {
    $this->loginAdmin();
    $edit = array(
      'dcycle_policy' => 'dcycle:dcycleQuickstartPolicy',
      'dcycle_environment_type' => 'dev',
      'dcycle_project_type' => 'website',
    );
    $this->drupalPost('admin/config/development/dcycle', $edit, 'Save configuration');
    $this->assertNoText('Your deployment module is');
    $this->assertText('Please create and enable a deployment module');
    dcycle_mockable_set('Dcycle', 'dcycleMockableModules', 'dcycleMockModules', 'addModule', array(
        'whatever_deploy' => array(
          'path' => 'sites/default/modules/custom/whatever_deploy',
        ),
      )
    );
    $this->drupalGet('admin/config/development/dcycle');
    $this->assertText('Your deployment module is');
    $this->assertNoText('Please create and enable a deployment module');
  }

}
